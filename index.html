<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>總管家管理系統 - 穩定版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-20 font-sans">

    <nav id="nav-bar" class="hidden bg-white border-b p-4 flex justify-between items-center px-8 shadow-sm sticky top-0 z-50">
        <div class="flex items-center space-x-3">
            <span class="text-xl font-black text-blue-700">總管家包租代管</span>
        </div>
        <div class="flex items-center space-x-4">
            <span id="user-display" class="text-slate-600 font-bold bg-slate-100 px-4 py-1.5 rounded-full text-sm"></span>
            <button onclick="location.reload()" class="text-slate-400 hover:text-red-500 text-sm font-black transition">安全登出</button>
        </div>
    </nav>

    <div id="login-page" class="flex items-center justify-center min-h-screen bg-slate-900">
        <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md border-t-8 border-blue-600">
            <h1 class="text-3xl font-black text-center text-slate-800 mb-8 tracking-tighter">總管家系統登入</h1>
            <div class="space-y-5">
                <input type="text" id="username" placeholder="帳號" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                <input type="password" id="password" placeholder="密碼" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none focus:border-blue-500 bg-slate-50">
                <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg text-lg">進入系統</button>
            </div>
        </div>
    </div>

    <div id="main-dashboard" class="hidden max-w-6xl mx-auto p-4 md:p-6">
        
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100 mb-12">
            <h2 id="form-title" class="text-lg font-black mb-6 flex items-center text-slate-800"><span class="w-1.5 h-6 bg-blue-600 mr-3 rounded-full"></span>房屋案件登記/修改</h2>
            <form id="house-form" class="grid grid-cols-1 md:grid-cols-3 gap-5">
                <input type="hidden" id="edit-id">
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">業務人員</label><input type="text" id="agent" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" required></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">刊登時間</label><input type="date" id="post_date" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" required></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">房屋所有權人</label><input type="text" id="owner" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" required></div>
                <div class="space-y-1 md:col-span-3"><label class="text-xs font-bold text-slate-400">房屋地址</label><input type="text" id="address" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" required></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">月租金</label><input type="number" id="rent" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" required></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">管理月費</label><input type="number" id="manage_fee" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" value="0"></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">車位月租金</label><input type="number" id="parking_fee" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none" value="0"></div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">房型</label>
                    <select id="room_type" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none bg-slate-50">
                        <option>套房</option><option>兩房</option><option>三房</option><option>四房以上</option>
                    </select>
                </div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">建物型態</label>
                    <select id="build_type" class="w-full border-2 border-slate-100 p-3 rounded-xl outline-none bg-slate-50">
                        <option>透天</option><option>公寓</option><option>華厦</option><option>電梯大樓</option>
                    </select>
                </div>
                <div class="space-y-1"><label class="text-xs font-bold text-slate-400">案件進度</label>
                    <select id="status" class="w-full border-2 border-blue-200 p-3 rounded-xl outline-none bg-blue-50 font-bold text-blue-700">
                        <option value="招租中">招租中</option><option value="已出租">已出租</option>
                    </select>
                </div>
                <div class="md:col-span-3 flex gap-4">
                    <button type="submit" id="submit-btn" class="flex-1 bg-blue-700 text-white font-black py-4 rounded-xl shadow-lg">提交儲存</button>
                    <button type="button" id="cancel-edit" class="hidden bg-slate-200 text-slate-600 font-bold px-8 py-4 rounded-xl">取消修改</button>
                </div>
            </form>
        </div>

        <div id="active-list" class="space-y-8 mb-16"></div>

        <h3 class="text-xl font-black mb-6 text-green-700">✅ 已成功出租物件</h3>
        <div class="bg-white rounded-2xl shadow-sm border overflow-x-auto">
            <table class="w-full text-left min-w-[900px]">
                <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b">
                    <tr><th class="p-4">刊登時間</th><th class="p-4">業務人員</th><th class="p-4">房屋地址</th><th class="p-4">租金明細</th><th class="p-4 text-center">操作</th></tr>
                </thead>
                <tbody id="done-list" class="divide-y divide-slate-100"></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyB0DqTg1tHiyyvAf4_eXU9Iq80oQwGLnBg",
            authDomain: "name1-f188a.firebaseapp.com",
            projectId: "name1-f188a",
            storageBucket: "name1-f188a.firebasestorage.app",
            messagingSenderId: "232467406209",
            appId: "1:232467406209:web:3f0aabbde3b99829f29c80"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;

        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            if (user === 'ueue31' && pass === '0919821208') { currentUser = { id: user, role: 'admin' }; initApp(); }
            else if (user === '24928555' && pass === '12345678') { currentUser = { id: user, role: 'editor' }; initApp(); }
            else { alert("帳號密碼錯誤！"); }
        }

        function initApp() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('nav-bar').classList.remove('hidden');
            document.getElementById('user-display').innerText = `登入者：${currentUser.id}`;
            document.getElementById('post_date').valueAsDate = new Date();
            startRealtimeUpdate();
        }

        document.getElementById('house-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const editId = document.getElementById('edit-id').value;
            const data = {
                agent: document.getElementById('agent').value,
                post_date: document.getElementById('post_date').value,
                owner: document.getElementById('owner').value,
                address: document.getElementById('address').value,
                rent: Number(document.getElementById('rent').value),
                manage_fee: Number(document.getElementById('manage_fee').value),
                parking_fee: Number(document.getElementById('parking_fee').value),
                room_type: document.getElementById('room_type').value,
                build_type: document.getElementById('build_type').value,
                status: document.getElementById('status').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editId) { await db.collection("houses").doc(editId).update(data); resetForm(); }
            else { data.createdAt = firebase.firestore.FieldValue.serverTimestamp(); await db.collection("houses").add(data); this.reset(); document.getElementById('post_date').valueAsDate = new Date(); }
        });

        function editDoc(id, dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            document.getElementById('edit-id').value = id;
            document.getElementById('agent').value = data.agent;
            document.getElementById('post_date').value = data.post_date;
            document.getElementById('owner').value = data.owner;
            document.getElementById('address').value = data.address;
            document.getElementById('rent').value = data.rent;
            document.getElementById('manage_fee').value = data.manage_fee;
            document.getElementById('parking_fee').value = data.parking_fee;
            document.getElementById('room_type').value = data.room_type;
            document.getElementById('build_type').value = data.build_type;
            document.getElementById('status').value = data.status;
            document.getElementById('submit-btn').innerText = "確認儲存修改";
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() { document.getElementById('house-form').reset(); document.getElementById('edit-id').value = ""; document.getElementById('submit-btn').innerText = "提交儲存"; document.getElementById('cancel-edit').classList.add('hidden'); }
        document.getElementById('cancel-edit').onclick = resetForm;

        async function updateStatus(id, newStatus) { await db.collection("houses").doc(id).update({ status: newStatus }); }
        async function deleteDoc(id) { if (confirm("確定刪除嗎？")) { await db.collection("houses").doc(id).delete(); } }

        function startRealtimeUpdate() {
            // 這裡移除 orderBy 確保在沒有索引的情況下也能顯示資料
            db.collection("houses").onSnapshot((snapshot) => {
                const activeArea = document.getElementById('active-list');
                const doneList = document.getElementById('done-list');
                activeArea.innerHTML = ''; doneList.innerHTML = '';
                let groupedActive = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    const dataStr = encodeURIComponent(JSON.stringify(data));
                    const total = data.rent + data.manage_fee + data.parking_fee;
                    const isAdmin = currentUser.role === 'admin';

                    if (data.status === '已出租') {
                        doneList.innerHTML += `<tr><td class="p-4 text-xs font-mono">${data.post_date}</td><td class="p-4 font-bold">${data.agent}${isAdmin?`<br><span class='text-blue-500 text-[10px]'>屋主：${data.owner}</span>`:''}</td><td class="p-4 text-slate-500">${data.address}</td><td class="p-4 text-right font-bold">$${total.toLocaleString()}</td><td class="p-4 text-center">${isAdmin?`<button onclick="editDoc('${id}','${dataStr}')" class="bg-slate-800 text-white px-2 py-1 rounded text-xs">修改</button><button onclick="deleteDoc('${id}')" class="text-red-500 text-xs ml-2">刪除</button>`:`<button onclick="updateStatus('${id}','招租中')" class="text-blue-500 text-xs">回復</button>`}</td></tr>`;
                    } else {
                        if (!groupedActive[data.agent]) groupedActive[data.agent] = [];
                        groupedActive[data.agent].push({id, dataStr, total, ...data});
                    }
                });

                for (let agent in groupedActive) {
                    activeArea.innerHTML += `<div class="bg-white rounded-2xl shadow-sm border border-blue-100 overflow-hidden mb-6"><div class="bg-blue-600 px-6 py-3 text-white font-black">業務員：${agent}</div><div class="divide-y">
                        ${groupedActive[agent].map(item => `<div class="p-6 flex justify-between items-center"><div><p class="font-black text-slate-800 text-xl">${item.address}</p><div class="flex gap-2 text-[10px] font-bold mt-1"><span class="bg-slate-100 px-2 py-0.5 rounded">刊登：${item.post_date}</span><span class="bg-blue-50 text-blue-500 px-2 py-0.5 rounded">${item.build_type}/${item.room_type}</span>${isAdmin?`<span class="bg-green-50 text-green-600 px-2 py-0.5 rounded italic">屋主：${item.owner}</span>`:''}</div></div><div class="flex items-center space-x-6"><div class="text-right font-black text-blue-700 text-xl">$${item.total.toLocaleString()}</div>${isAdmin?`<button onclick="editDoc('${item.id}','${item.dataStr}')" class="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold text-xs">修改資料</button>`:`<button onclick="updateStatus('${item.id}','已出租')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm">出租</button>`}</div></div>`).join('')}
                    </div></div>`;
                }
            });
        }
    </script>
</body>
</html>
